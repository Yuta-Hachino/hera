# Heraエージェントから家族フェーズまで一貫テスト

## 概要

このテストは、Heraエージェントとのやりとりから家族フェーズまで一貫して動作を確認するためのテストファイルです。

## テスト内容

### 1. ヘルスチェック
- APIサーバー（ポート8080）の状態確認
- ADK Web UI（ポート8000）の状態確認

### 2. セッション管理
- セッション作成
- セッション状態取得
- セッション完了

### 3. Heraエージェントとの会話
- ユーザー情報の収集
- プロファイルの更新
- 進捗の追跡

### 4. 画像処理
- ユーザー画像アップロード
- パートナー画像生成
- 子ども画像生成

## 実行方法

### 前提条件

1. **ADK Web UIを起動**
```bash
cd backend
adk web agents
```

2. **APIサーバーを起動**
```bash
cd backend
python api/app.py
```

### テスト実行

**方法1: 自動実行スクリプト**
```bash
cd backend
./run_test.sh
```

**方法2: 直接実行**
```bash
cd backend
python test_full_flow.py
```

## テストフロー

1. **ヘルスチェック** - 必要なサービスが起動しているか確認
2. **セッション作成** - 新しいセッションを作成
3. **Heraエージェントとの会話** - 以下の情報を収集：
   - 年齢（33歳）
   - 居住地（東京）
   - 交際状況（独身）
   - 理想のパートナー像
   - パートナーの顔の特徴
   - ユーザーの性格
   - 子どもの希望
4. **セッション状態確認** - 収集された情報を確認
5. **セッション完了** - 情報収集の完了
6. **画像処理** - 画像のアップロード・生成
7. **最終状態確認** - すべての処理が完了したことを確認

## 期待される結果

- ✅ すべてのAPIエンドポイントが正常に動作
- ✅ Heraエージェントとの会話が正常に進行
- ✅ ユーザープロファイルが適切に収集・保存
- ✅ 画像処理が正常に動作
- ✅ セッションデータが適切に永続化

## トラブルシューティング

### よくある問題

1. **APIサーバーが起動していない**
   ```
   ❌ APIが起動していません。先にAPIサーバーを起動してください。
   ```
   → `cd backend && python api/app.py` でAPIサーバーを起動

2. **ADK Web UIが起動していない**
   ```
   ❌ ADK Web UIが起動していません。先にADK Web UIを起動してください。
   ```
   → `cd backend && adk web agents` でADK Web UIを起動

3. **エージェントとの通信エラー**
   ```
   ❌ エージェントとの通信に失敗しました
   ```
   → ADK Web UIでエージェントが正常に起動しているか確認

### ログの確認

テスト実行中にエラーが発生した場合、以下のログを確認してください：

- APIサーバーのログ（ターミナル出力）
- ADK Web UIのログ（ターミナル出力）
- 生成されたセッションファイル（`backend/tmp/user_sessions/`）

## 生成されるファイル

テスト実行後、以下のファイルが生成されます：

```
backend/tmp/user_sessions/{session_id}/
├── user_profile.json          # ユーザープロファイル
├── conversation_history.json # 会話履歴
└── photos/                    # 画像ファイル
    ├── user.png              # ユーザー画像
    ├── partner.png           # パートナー画像
    └── child_1.png           # 子ども画像
```

## 注意事項

- テスト実行前に、必要なサービス（APIサーバー、ADK Web UI）が起動していることを確認してください
- テストは実際のAIエージェントと通信するため、インターネット接続が必要です
- テスト実行中は他の操作を避けてください
