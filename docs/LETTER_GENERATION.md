# 手紙生成システム仕様書

## 概要

手紙生成システムは、生成されたストーリーを基に、未来の家族から現在のユーザーへ送る温かい手紙を自動生成します。手紙は感謝と励ましに満ちた内容で、ユーザーに希望と前向きな気持ちを提供することを目的としています。

## 設計思想

### 1. 温かみのある手紙らしさ

単なる情報伝達ではなく、心のこもった手紙として構成します。

**重視するポイント:**
- 親しみやすい語り口
- 感謝の気持ち
- 励ましと希望
- 未来への期待

### 2. ユーザーへのパーソナライゼーション

ユーザー名や家族構成を反映し、自分のための手紙だと感じられる内容にします。

**活用する情報:**
- ユーザー名
- 家族メンバーの名前
- 旅行計画の詳細
- 生成されたストーリー

### 3. 前向きなメッセージ

現在のユーザーを勇気づけ、未来への希望を感じられる内容にします。

## アーキテクチャ

### クラス構造

```python
class LetterGenerator:
    """手紙生成クラス"""

    LETTER_PROMPT_TEMPLATE: str  # プロンプトテンプレート
    model: GenerativeModel       # Gemini モデル

    def __init__(self, model_name: str | None = None)
    async def generate_letter(
        story: str,
        trip_info: Dict[str, Any],
        family_members: List[Persona],
        user_name: str | None = None
    ) -> str
```

### 生成フロー

```
入力データ
  ├─ story: 生成されたストーリー
  ├─ trip_info: 旅行情報
  ├─ family_members: 家族メンバーリスト
  └─ user_name: ユーザー名（オプション）
       ↓
  バリデーション
       ↓
  データ整形
  ├─ 家族構成テキスト化
  ├─ 家族名リスト化
  ├─ 日付生成
  └─ ユーザー名設定
       ↓
  プロンプト生成
       ↓
  Gemini API 呼び出し
       ↓
  手紙（600-900文字）
```

## 手紙の構成

### 5部構成の詳細

#### 1. 宛名

**形式:**
```
未来の[ユーザー名]へ
```

**パターン:**
- ユーザー名が指定されている場合: `未来の太郎へ`
- ユーザー名が不明な場合: `未来のあなたへ`

#### 2. 前書き（1-2段落）

**目的:** 感謝の気持ちを伝える

**含めるべき要素:**
- 週末の計画を立ててくれたことへの感謝
- 家族みんなが楽しみにしている気持ち
- 温かいトーン

**例:**
```
いつも私たち家族のことを考えてくれて、ありがとう。
週末の旅行の計画を一緒に立ててくれて、みんな本当に嬉しいんだ。
子供たちも、パートナーも、あなたとの時間を心待ちにしているよ。
```

#### 3. 本文（3-4段落）

**目的:** 旅行への期待と想いを伝える

**含めるべき要素:**
- 行き先についての具体的な期待
- やりたいことへのワクワク感
- 家族それぞれの想い（子供の視点も含める）
- この旅行が特別な思い出になる予感

**例:**
```
公園でのピクニック、本当に楽しみだね。
さくらは遊具で遊ぶのをずっと待ち望んでいて、毎日のように「まだ？」って聞いてくるんだ。
ゆうも、お弁当を一緒に作りたいって言っているよ。

青空の下で、みんなで笑い合いながら過ごす時間を想像するだけで、
胸が温かくなる。きっと素敵な一日になるはずだよ。
```

#### 4. 結び（1-2段落）

**目的:** 現在のユーザーへの励ましとエール

**含めるべき要素:**
- 現在のあなたへの感謝
- 未来の家族がいつもそばにいることを伝える
- 前向きなメッセージ

**例:**
```
今のあなたが、私たちのために頑張ってくれているから、
こんな幸せな未来が待っているんだよね。
どんなときも、未来の家族がいつもそばにいることを忘れないで。

一緒に、素敵な未来を作っていこうね。
楽しみに待っているよ。
```

#### 5. 署名

**形式:**
```
[日付]
未来の家族より
[家族メンバーの名前リスト]
```

**例:**
```
2025年10月22日
未来の家族より
さくら、ゆう、未来のパートナー
```

## プロンプト設計

### プロンプトテンプレート

```python
LETTER_PROMPT_TEMPLATE = """
あなたは未来の家族として、現在のユーザーへ温かい手紙を書く執筆者です。
以下の情報を基に、感謝と希望に満ちた手紙を日本語で作成してください。

## 家族構成
{family_members}

## 生成されたストーリー
{story}

## 旅行情報
- 行き先: {destination}
- やりたいこと: {activities}

## 手紙作成の要件
（詳細は実装コード参照）
"""
```

### コンテキスト情報の構造化

#### 家族構成の整形

```python
- パートナー「未来のパートナー」
  性格: 共感的、思いやり、支えになりたい

- 第1子「さくら」
  性格: 明るい、冒険心

- 第2子「ゆう」
  性格: 思いやり、甘えん坊
```

#### 日付生成

```python
from datetime import datetime

current_date = datetime.now().strftime("%Y年%m月%d日")
# 例: "2025年10月22日"
```

### 出力形式の指定

**文字数:** 600-900文字程度

**文体:**
- 温かく、親しみやすい
- 箇条書きは使わない
- 二人称は「あなた」「きみ」など親しみを込めて

**トーン:**
- 感謝と愛情が伝わる
- 前向きで励ましになる
- 希望に満ちた

## 実装詳細

### バリデーション

```python
# 必須情報のチェック
if not story or not story.strip():
    raise ValueError("ストーリーが空です")

if not trip_info.get("destination"):
    raise ValueError("旅行先（destination）が指定されていません")

activities = trip_info.get("activities", [])
if not activities:
    raise ValueError("やりたいこと（activities）が指定されていません")

if not family_members:
    raise ValueError("家族メンバー情報が指定されていません")
```

### データ整形

```python
def _format_family_members(personas: List[Persona]) -> str:
    """ペルソナリストを読みやすいテキストに整形"""
    lines = []
    for persona in personas:
        lines.append(f"- {persona.role}「{persona.name}」")
        lines.append(f"  性格: {', '.join(persona.traits)}")
    return "\n".join(lines)

def _extract_family_names(personas: List[Persona]) -> str:
    """家族メンバーの名前を抽出"""
    names = [persona.name for persona in personas]
    return "、".join(names)
    # 例: "さくら、ゆう、未来のパートナー"
```

### 非同期実行

```python
async def generate_letter(...) -> str:
    # プロンプト生成
    prompt = self.LETTER_PROMPT_TEMPLATE.format(...)

    # 非同期でAPI呼び出し
    loop = asyncio.get_event_loop()
    response = await loop.run_in_executor(
        None,
        self.model.generate_content,
        prompt
    )

    return response.text.strip()
```

## 品質管理

### 品質基準

| 項目 | 基準 |
|-----|------|
| 文字数 | 600-900文字 |
| 構成 | 明確な5部構成 |
| パーソナライゼーション | ユーザー名や家族名が適切に使用 |
| 感情表現 | 感謝と励ましが伝わる |
| トーン | 温かく前向き |

### レビューガイドライン

生成された手紙が以下の要件を満たしているか確認：

**チェックリスト:**
- [ ] 5部構成になっているか（宛名、前書き、本文、結び、署名）
- [ ] ユーザー名が適切に使用されているか
- [ ] 家族メンバーの名前が含まれているか
- [ ] 感謝の気持ちが伝わるか
- [ ] 励ましのメッセージがあるか
- [ ] 温かいトーンか
- [ ] 文字数が適切か（600-900文字）

### 改善のフィードバックループ

```
手紙生成
  ↓
品質チェック
  ↓
NG → プロンプト改善 → 再生成
  ↓
OK → 保存・返却
```

## エラーハンドリング

### エラーケースと対処

| エラーケース | 対処方法 |
|------------|---------|
| API エラー | 空文字列を返す（ストーリーのみ返却） |
| タイムアウト | リトライ（最大3回） |
| 不適切な出力 | プロンプト調整後に再試行 |

### エラー時の動作

```python
try:
    letter = await letter_generator.generate_letter(...)
except Exception as e:
    logger.error(f"手紙生成中にエラーが発生しました: {e}", exc_info=True)
    letter = ""  # 空文字列を保存
```

手紙生成に失敗しても、ストーリーは返却されるため、ユーザー体験は維持されます。

## パフォーマンス

### 処理時間

| 項目 | 時間（目安） |
|-----|------------|
| データ整形 | < 100ms |
| プロンプト生成 | < 50ms |
| API 呼び出し | 5-10秒 |
| **合計** | **5-10秒** |

### 最適化の方針

1. **プロンプト最適化**
   - 不要な情報を削減
   - トークン数の削減

2. **並列処理**
   - ストーリー生成と並列実行可能（将来的な拡張）

## 使用例

### 基本的な使用方法

```python
from family.letter_generator import LetterGenerator

# ジェネレーター作成
generator = LetterGenerator()

# 手紙生成
letter = await generator.generate_letter(
    story=generated_story,
    trip_info={
        "destination": "都立公園",
        "activities": ["遊具遊び", "ピクニック", "散歩"]
    },
    family_members=[partner_persona, child1_persona, child2_persona],
    user_name="太郎"
)

print(letter)
```

### ユーザー名なしの場合

```python
# ユーザー名が不明な場合
letter = await generator.generate_letter(
    story=story,
    trip_info=trip_info,
    family_members=family_members,
    user_name=None  # "未来のあなたへ" となる
)
```

### カスタムモデルの使用

```python
# 異なるモデルを使用
generator = LetterGenerator(model_name="gemini-1.5-pro")
```

## サンプル出力

### 完全な手紙の例

```
未来の太郎へ

いつも私たち家族のことを考えてくれて、本当にありがとう。週末の旅行の計画を一緒に立ててくれて、みんな心から嬉しく思っているよ。子供たちも、パートナーも、あなたとの時間をとても楽しみにしているんだ。

都立公園でのピクニック、本当に待ち遠しいね。さくらは遊具で遊ぶことをずっと楽しみにしていて、毎日のように「早く行きたい！」って言っているんだよ。ゆうも、お弁当を一緒に作りたいって張り切っているよ。

青空の下、芝生の上でお弁当を広げて、みんなで笑い合う時間を想像するだけで、胸が温かくなる。子供たちが遊具ではしゃぐ姿を見ながら、パートナーと二人で微笑み合う瞬間が、きっと素敵な思い出になるはずだよ。

公園を散歩しながら、家族で話す何気ない会話も、かけがえのない時間になるんだろうね。こんな小さな幸せの積み重ねが、私たち家族の宝物になっていく。

今のあなたが、私たちのために一生懸命頑張ってくれているから、こんな幸せな未来が待っているんだよね。どんなときも、未来の家族がいつもそばにいることを忘れないでね。

一緒に、素敵な未来を作っていこう。楽しみに待っているよ。

2025年10月22日
未来の家族より
さくら、ゆう、未来のパートナー
```

## 今後の拡張

### 検討中の機能

1. **フォーマットバリエーション**
   - カジュアル、フォーマルなど複数のスタイル

2. **子供からの手紙**
   - 子供の視点での手紙生成
   - 年齢に応じた文体調整

3. **イベント対応**
   - 誕生日、記念日などのイベント用手紙

4. **画像統合**
   - 手書き風のフォント画像生成
   - 子供の落書き画像の追加

## 関連ドキュメント

- [family/README.md](../family/README.md) - モジュール詳細
- [FAMILY_AGENT_DESIGN.md](FAMILY_AGENT_DESIGN.md) - 設計全体
- [STORY_GENERATION.md](STORY_GENERATION.md) - ストーリー生成仕様
- [family/letter_generator.py](../family/letter_generator.py) - 実装コード
