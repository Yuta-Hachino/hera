version: '3.8'

services:
  # ============================================
  # バックエンドAPI (Flask)
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: hera-backend
    ports:
      - "8080:8080"
    environment:
      # Gemini API
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=gemini-pro

      # Firebase/GCP設定
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/service-account-key.json
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET}

      # セッションとストレージモード
      - SESSION_TYPE=firebase
      - STORAGE_MODE=firebase
      - FIREBASE_MOCK=false

      # Flask設定
      - FLASK_DEBUG=False
      - PORT=8080
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ALLOWED_ORIGINS=http://localhost:3000,http://frontend:3000
    volumes:
      # Firebase認証キー（ローカル開発用）
      - ./backend/service-account-key.json:/app/service-account-key.json:ro
      # ログの永続化
      - backend-logs:/app/logs
    networks:
      - hera-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # Google ADK開発UI
  # ============================================
  adk:
    image: python:3.11-slim
    container_name: hera-adk
    working_dir: /app
    ports:
      - "8000:8000"
    environment:
      # Gemini API
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - PYTHONPATH=/app

      # Firebase/GCP設定
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - FIREBASE_SERVICE_ACCOUNT_PATH=/app/service-account-key.json
      - GCS_BUCKET_NAME=${GCS_BUCKET_NAME}
      - FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET}

      # セッションとストレージモード
      - SESSION_TYPE=firebase
      - STORAGE_MODE=firebase
      - FIREBASE_MOCK=false
    volumes:
      - ./backend:/app
      # Firebase認証キー
      - ./backend/service-account-key.json:/app/service-account-key.json:ro
      # ログ
      - backend-logs:/app/logs
    networks:
      - hera-network
    command: >
      bash -c "
        pip install --no-cache-dir -r requirements.txt &&
        python -m google.adk dev --port 8000 --host 0.0.0.0
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      - backend

  # ============================================
  # フロントエンド (Next.js)
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Firebase設定（ビルド時）
        NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
        NEXT_PUBLIC_FIREBASE_APP_ID: ${NEXT_PUBLIC_FIREBASE_APP_ID}
        NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
        NEXT_PUBLIC_API_URL: http://localhost:8080
        NEXT_PUBLIC_FIREBASE_MOCK: "false"
    container_name: hera-frontend
    ports:
      - "3000:3000"
    environment:
      # Firebase設定（ランタイム）
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${NEXT_PUBLIC_FIREBASE_APP_ID}
      - NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_FIREBASE_MOCK=false
      - NODE_ENV=production
    networks:
      - hera-network
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

# ============================================
# ボリューム定義
# ============================================
volumes:
  backend-logs:
    driver: local

# ============================================
# ネットワーク定義
# ============================================
networks:
  hera-network:
    driver: bridge
